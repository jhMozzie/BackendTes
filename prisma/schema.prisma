// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int     @id @default(autoincrement())
  description String  @unique
  users       User[]
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  username   String
  password   String
  phone      String?
  birthdate  DateTime? // ğŸ‘ˆ Nuevo campo: fecha de nacimiento opcional
  status     String    @default("Activo") // Activo | Inactivo

  roleId     Int
  role       Role      @relation(fields: [roleId], references: [id])

  academies  Academy[]
  students   Student[]
}

model Academy {
  id      Int    @id @default(autoincrement())
  name    String

  // RelaciÃ³n uno a muchos (una academia organiza varios campeonatos)
  userId  Int
  user    User   @relation(fields: [userId], references: [id])
  championships Championship[]

  // RelaciÃ³n muchos a muchos (una academia puede participar en muchos campeonatos)
  championshipLinks AcademyOnChampionships[]

  students Student[]
}

model Championship {
  id          Int      @id @default(autoincrement())
  name        String
  startDate   DateTime
  location    String         // ğŸŸï¸ Lugar o recinto (ej. "Estadio Nacional")
  district    String?        // ğŸ™ï¸ Distrito o ciudad (ej. "JesÃºs MarÃ­a")
  province    String?        // ğŸŒ† Provincia o regiÃ³n (ej. "Lima")
  country     String?        // ğŸŒ PaÃ­s (ej. "PerÃº")
  description String?        // ğŸ‘ˆ AÃ‘ADE ESTA LÃNEA (Texto opcional)
  image       String?        // ğŸ–¼ï¸ Ruta de imagen (frontend o bucket)
  status      String @default("PlanificaciÃ³n") // ğŸ“Š Estado del campeonato

  // ğŸ”— Relaciones
  academyId   Int
  academy     Academy   @relation(fields: [academyId], references: [id])
  academyLinks AcademyOnChampionships[]
  categories  ChampionshipCategory[]
}

model AcademyOnChampionships {
  id              Int           @id @default(autoincrement())
  academyId       Int
  championshipId  Int

  academy         Academy       @relation(fields: [academyId], references: [id])
  championship    Championship  @relation(fields: [championshipId], references: [id])

  @@unique([academyId, championshipId])
}

model Student {
  id         Int        @id @default(autoincrement())
  firstname  String
  lastname   String
  birthdate  DateTime
  beltId     Int        // ğŸ‘ˆ Nuevo: referencia al cinturÃ³n (kyu)
  belt       Belt       @relation(fields: [beltId], references: [id])

  userId     Int?
  user       User?       @relation(fields: [userId], references: [id])
  academyId  Int
  academy    Academy    @relation(fields: [academyId], references: [id])

  participants Participant[]
}

model ChampionshipCategory {
  id             Int       @id @default(autoincrement())
  code           String?
  modality       String    // Kata o Kumite
  gender         String    // Masculino o Femenino
  weight         String?   // ğŸ‘ˆ 1. AÃ‘ADE ESTA LÃNEA
  beltMinId      Int       // ğŸ‘ˆ Nuevo: cinturÃ³n mÃ­nimo permitido
  beltMaxId      Int       // ğŸ‘ˆ Nuevo: cinturÃ³n mÃ¡ximo permitido
  ageRangeId     Int       // ğŸ‘ˆ Nuevo: rango de edad permitido
  championshipId Int

  beltMin        Belt      @relation("MinBelt", fields: [beltMinId], references: [id])
  beltMax        Belt      @relation("MaxBelt", fields: [beltMaxId], references: [id])
  ageRange       AgeRange  @relation(fields: [ageRangeId], references: [id])
  championship   Championship @relation(fields: [championshipId], references: [id])
  participants   Participant[]

  // ğŸ‘‡ 2. AÃ‘ADE 'weight' AL FINAL DE ESTA LÃNEA
  @@unique([championshipId, modality, gender, ageRangeId, beltMinId, beltMaxId, weight])
}

model Participant {
  id                      Int  @id @default(autoincrement())
  studentId               Int
  championshipCategoryId  Int

  student              Student             @relation(fields: [studentId], references: [id])
  championshipCategory ChampionshipCategory @relation(fields: [championshipCategoryId], references: [id])

  @@unique([studentId, championshipCategoryId])
}

// =============================================
// NUEVAS TABLAS BASE PARA AUTOMATIZAR CATEGORÃAS
// =============================================

// ğŸ¥‹ Cinturones / Kyu Levels
model Belt {
  id        Int       @id @default(autoincrement())
  name      String    // Blanco, Amarillo, Naranja, Verde, Azul, MarrÃ³n, Negro
  kyuLevel  Int       // 10 = Blanco ... 1 = MarrÃ³n, 0 = Negro
  students  Student[]
  minBeltCategories ChampionshipCategory[] @relation("MinBelt")
  maxBeltCategories ChampionshipCategory[] @relation("MaxBelt")
}

// ğŸ‘¶ Rangos Etarios (para categorÃ­as)
model AgeRange {
  id         Int      @id @default(autoincrement())
  label      String   // Ej: "8-9 aÃ±os"
  minAge     Int
  maxAge     Int
  categories ChampionshipCategory[]
}